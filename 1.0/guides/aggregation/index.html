<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<meta name="keyword" content="">

    <link rel="shortcut icon" href="/morphia/1.0/img/favicon.png">

    <title>Aggregation</title>

    <link rel="stylesheet" href="/morphia/1.0/lib/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="/morphia/1.0/lib/font-awesome/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="/morphia/1.0/css/mongodb-docs.css" type="text/css" />
<link rel="stylesheet" href="/morphia/1.0/css/overrides.css" type="text/css" />
<link rel="stylesheet" href="/morphia/1.0/lib/highlight/styles/idea.css" />
<link rel="stylesheet" href="/morphia/1.0/lib/bootstrap-toggle/bootstrap-toggle.min.css" type="text/css" />
<link rel="stylesheet" href="/morphia/1.0/css/java.css" type="text/css" />


  </head>

  <body>
  
  <section id="container" class="">
      
      <header id="header-db" class="row" role="navigation">
  <div class="header-content">
    <div class="toggle-nav pull-left">
        <i class="fa fa-bars"></i>
        <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
    </div>
    
    <div class="logo pull-left">
      <a href="/morphia/1.0/../">
        <img src="/morphia/1.0/img/logo-mongodb-header.png", alt="MongoDB.org" />
      </a>
    </div>
    
    <div>
<div class="nav-items pull-right">
  <a href="http://try.mongodb.org/" data-toggle="tooltip" data-placement="bottom" title="Try MongoDB in the browser">Try it Out</a>
  <a href="http://www.mongodb.org/downloads" data-toggle="tooltip" data-placement="bottom" title="Download MongoDB">Downloads</a>
  <a href="http://www.mongodb.org/get-involved" data-toggle="tooltip" data-placement="bottom" title="Get involved with MongoDB">Community</a>
  <a href="http://docs.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Documentation">Docs</a>
  <a href="http://blog.mongodb.org" data-toggle="tooltip" data-placement="bottom" title="The MongoDB Blog">Blog</a>
  <div id="search">
<form method="get" action="//www.google.com/search" target="_blank">
    <input type="text" name="searchQuery" size="20" value="" autocomplete="off" placeholder="Search docs">
    <input type="hidden" name="site" value="/morphia/1.0">
    <input type="hidden" name="q" value="">
    <label for="searchQuery"><i class="fa fa-search fa-1"></i></label>
</form>
</div>

</div>
</div>

  </div>
</header>

      

      
<aside id="sidebar" class="sidebar">
    <div class="ssidebar nav-collapse">
      <div class="ssidebarwrapper">
        <h3>
          <a class="index-link" href="/morphia/1.0/../">Morphia</a>
          <a class="version pull-right" href="/morphia/1.0">1.0</a>
        </h3>

        
        <ul class="sidebar-menu">
          
          
          
          
          
          
          
          
          
          
          
          

          
          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
    
      
    
  


          
            
            









  
    
    
      
      
        
        
        
        
        
        
        
        









  


        
          
        
      
    
      
      
        
        
        
        
        
        
        
        









  
  
  
  
  
  
  
  

  
    
    
    
      
    
  
  


        
      
    
    
  


          
            
            









  


          
            
            









  


          
            
            









  


          

          

          
            
            
















<li class="toctree-l1 ">
  <a href="/morphia/1.0/getting-started/" class="">
      <i class='fa fa-road'></i>
      <span>Getting Started</span>
      <span class="menu-arrow fa fa-angle-right"></span>
  </a>
    <ul >
        
        
        
        
















    <li class="toctree-l2">
    <a href="/morphia/1.0/getting-started/installation-guide/">
        <i class='fa'></i>
        Installation Guide
    </a>
  </li>


        
        
        
        
        
















    <li class="toctree-l2">
    <a href="/morphia/1.0/getting-started/quick-tour/">
        <i class='fa'></i>
        Quick Tour
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            













  




<li class="toctree-l1  current">
  <a href="/morphia/1.0/guides/" class="">
      <i class='fa fa-book'></i>
      <span>Reference Guides</span>
      <span class="menu-arrow fa fa-angle-down"></span>
  </a>
    <ul  class="current">
        
        
        
        
















    <li class="toctree-l2">
    <a href="/morphia/1.0/guides/annotations/">
        <i class='fa fa-file-text-o'></i>
        Annotations
    </a>
  </li>


        
        
        
        
        













  




    <li class="toctree-l2">
    <a href="/morphia/1.0/guides/aggregation/">
        <i class='fa fa-file-text-o'></i>
        Aggregation
    </a>
  </li>


        
        
    </ul>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/morphia/1.0/javadoc/">
        <i class='fa fa-file-text-o'></i>
        API Documentation
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="/morphia/1.0/issues-help/">
        <i class='fa fa-life-ring'></i>
        Issues &amp; Help
    </a>
  </li>


          
            
            
















    <li class="toctree-l1">
    <a href="https://github.com/mongodb/morphia">
        <i class='fa fa-github'></i>
        Source Code
    </a>
  </li>


          
        </ul>
        
    </div>
  </div>
  
</aside>

<div class="option-popup closed hidden" id="optionsVersionsPopup">
<div class="option-header">
  <i class="fa fa-gear"></i>
  <span>OPTIONS</span>
  <i class="fa fa-angle-up pull-right"></i>
</div>
<div class="option-body">
  <ul>
      
      <li>
        <label>Version</label>
        <div class="btn-group btn-group-xs pull-right">
          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            Select Version <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" id="optionsVersionsMenu">
          </ul>
        </div>
      </li>

   


    

  </ul>
</div>
</div>



      
      <section id="main-content" class="content">
          <section class="main-column pull-left">
            <div class="document">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body">


   
<a class="edit-link" href="https://github.com/mongodb/morphia/blob/master/docs/reference/content/guides/aggregation.md" target="_blank" title="Edit guides/aggregation.md on GitHub"><i class="fa fa-pencil-square-o"></i></a>










<div class="bc">
<ul>
  
  
  
  
  
  <li><a href="/morphia/1.0/guides/">Reference Guides</a> <i class="fa fa-angle-right"></i></li>
  <li>Aggregation</li>
</ul>
</div>




<h1 id="aggregation">Aggregation</h1>

<p>The <a href="http://docs.mongodb.org/manual/aggregation/">aggregation</a> framework in MongoDB allows you to define a series of operations and
filters (called a pipeline) against the data in a collection.  These pipelines can be used for analytics or they can be used to convert
your data from one form to another.  This guide will not go in to the details of how aggregation works, however.  The official MongoDB
<a href="http://docs.mongodb.org/manual/aggregation/">documentation</a> has extensive tutorials on such details.  Rather, this guide will focus on
the Morphia API.  The examples shown here are taken from the <a href="https://github.com/mongodb/morphia/blob/master/morphia/src/test/java/org/mongodb/morphia/aggregation/AggregationTest.java
">tests</a> in Morphia itself.</p>

<p>Writing an aggregation pipeline starts just like writing a standard query.  As with querying, we start with the <code>Datastore</code>:</p>

<pre><code class="language-java">Iterator&lt;Author&gt; aggregate = datastore.createAggregation(Book.class)
      .group(&quot;author&quot;, grouping(&quot;books&quot;, push(&quot;title&quot;)))
      .out(Author.class, options);
</code></pre>

<p>As with querying, <code>createAggregation()</code> takes a <code>Class</code> literal.  This lets Morphia know which collection to perform this aggregation
against.  Because of the transformational operations available in the aggregation <a href="http://docs.mongodb
.org/manual/core/aggregation-pipeline/">pipeline</a>, Morphia can not validate as much as it can with querying so care will need to be taken to ensure
 document fields actual exist when referencing them in your pipeline.</p>

<h2 id="the-pipeline">The Pipeline</h2>

<p>Aggregation operations are comprised of a series of steps (or stages) in a pipeline.  Our example here has only the one stage: <code>group()</code>.
  This method is the Morphia equivalent of the <code>$group</code> operator.  This stage, as the name suggests, groups together documents based on the
  given field&rsquo;s
  values.  In this
  example,
   we are collecting
  together all the books by authort.</p>

<h2 id="options">Options</h2>

<p>The <code>options</code> reference passed to <code>out()</code> above is an instance of <a href="/javadoc/org/mongodb/morphia/aggregation/AggregationOptions.html"><code>AggregationOptions</code></a>.  There are a handful options here but there&rsquo;s one that deserves some
extra attention.  The aggregation pipeline, by default, returns everything &ldquo;inline&rdquo; which has the same 16MB limitations as all other
documents in MongoDB.  As of MongoDB 2.6, you can specify the <code>$out</code> pipeline stage to tailor this.  This is what the value of
<a href="http://api.mongodb.org/java/3.0/com/mongodb/AggregationOptions.html#getOutputMode--">AggregationOptions#getOutputMode()</a> determines.  The
 default value is to return them inline but it can be configured to return a cursor instead which means that your result size can be
much larger than 16MB.</p>

<h3 id="out">$out</h3>

<p>If the aggregation pipeline is a complicated or expensive pipeline that takes quite some time to execute, it can be beneficial to save
the results of the pipeline for later retrieval. (Think pre-aggregation of traffic statistics, e.g.)  For these cases, the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/out/#pipe._S_out"><code>$out</code></a> operator was introduced in MongoDB 2.6.  Morphia
exposes this pipeline stage via the <a href="/javadoc/org/mongodb/morphia/aggregation/AggregationPipeline.html#out-java.lang.Class-"><code>out()</code></a> method on
<code>AggregationPipeline.</code>Using this pipeline stage, the results can be deposited in to a collection and be
retrieved at some arbitrary time later.  There is one critical caveat to be aware of,  however.  <em><strong>This operation will replace the
collection contents and any existing data in the collection will be lost.</strong></em>  You need to be absolutely sure you give the correct output
 location when using this option because recovery might be difficult.</p>

<p>Whether the results are written to a new collection or simply returned as a cursor is controlled by the options you give to Morphia.</p>






<div id="btnv">
  
  <div class="pull-left">
  <a class="navigation prev" href="/morphia/1.0/guides/annotations/">
      <i class="fa fa-long-arrow-left"> </i> Annotations
  </a>
  </div>
  
  
</div>
</div>


</div>
<div class="right-column">
<div class="wrapper">
  
  <div class="toc">
    <span class="toc-header">On this page</span>
    <nav id="TableOfContents">
<ul>
<li><a href="#aggregation">Aggregation</a>
<ul>
<li><a href="#the-pipeline">The Pipeline</a></li>
<li><a href="#options">Options</a>
<ul>
<li><a href="#out">$out</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
  
</div>
</div>

</div>
</div>
</div>
</section>
</section>

</section>


<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
   URL_ROOT:    "/morphia/1.0",
   VERSION:     "1.0",
   COLLAPSE_INDEX: false,
   FILE_SUFFIX: '.html',
   HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="/morphia/1.0/js/jquery.js"></script>
<script type="text/javascript" src="/morphia/1.0/lib/bootstrap.js"></script>
<script type="text/javascript" src="/morphia/1.0/js/navbar.js"></script>
<script type="text/javascript" src="/morphia/1.0/lib/highlight/highlight.pack.js"></script>
<script type="text/javascript" src="/morphia/1.0/js/scripts.js"></script>
<script type="text/javascript" src="/morphia/1.0/lib/bootstrap-toggle/bootstrap-toggle.min.js"></script>
<script type="text/javascript" src="/morphia/1.0/js/java.js"></script>



<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-K75Z5Q"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
{'gtm.start': new Date().getTime(),event:'gtm.js'}
);var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K75Z5Q');</script>


<script type="text/javascript">
var _elqQ = _elqQ || [];
_elqQ.push(['elqSetSiteId', '413370795']);
_elqQ.push(['elqTrackPageView']);
(function () {
function async_load()
{ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//img03.en25.com/i/elqCfg.min.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x); }
if (window.addEventListener) window.addEventListener('DOMContentLoaded', async_load, false);
else if (window.attachEvent) window.attachEvent('onload', async_load);
})();
</script>

</body>
</html>

